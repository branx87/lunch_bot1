# Changelog - Система автоматического резервного копирования

## Версия 2.6.0 - Добавлена система автоматического резервного копирования

**Дата:** 2026-01-15

### Новые возможности

#### Автоматическое резервное копирование

- ✅ **Ежедневные автоматические бекапы** в 03:00 по московскому времени
- ✅ **Ротация по дням недели** - хранение 7 бекапов на Яндекс.Диске (понедельник-воскресенье)
- ✅ **Оптимизация размера** - бекап только данных за последние 3 месяца
- ✅ **Загрузка в облако** - автоматическая синхронизация с Яндекс.Диском
- ✅ **Сжатие gzip** - экономия места на диске
- ✅ **Автоматическая очистка** - удаление локальных бекапов старше 7 дней

#### Команды для администраторов

Добавлены новые команды в Telegram:

- `/backup` - создать резервную копию вручную
- `/backup --local` - создать только локальную копию (без загрузки в облако)
- `/backup_status` - посмотреть статус всех бекапов

#### Новые файлы

- `backup_manager.py` - модуль управления резервным копированием
- `BACKUP_SETUP.md` - подробная документация по настройке
- `BACKUP_QUICKSTART.md` - быстрый старт за 5 минут
- `.env.example` - пример файла с переменными окружения

### Изменения в существующих файлах

#### `cron_jobs.py`
- Добавлен импорт `backup_manager`
- Добавлена функция `_create_backup()` для автоматического бекапа
- Настроен cron-job на ежедневный запуск в 03:00

#### `handlers/commands.py`
- Добавлена функция `backup_command()` для ручного создания бекапов
- Добавлена функция `backup_status_command()` для просмотра статуса
- Зарегистрированы обработчики команд `/backup` и `/backup_status`

#### `requirements.txt`
- Добавлена зависимость `yadisk>=3.0.0`

#### `data/configs/.env`
- Добавлены переменные:
  - `YANDEX_DISK_TOKEN` - токен для доступа к Яндекс.Диску
  - `YANDEX_DISK_FOLDER` - папка на Яндекс.Диске для бекапов
  - `BACKUP_MONTHS` - количество месяцев данных для бекапа

#### `Dockerfile`
- Добавлено создание папки `/app/data/backups`
- PostgreSQL клиент уже был установлен (для pg_dump)

#### `docker-compose.yml`
- Добавлен volume `./data/backups:/app/data/backups`

### Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                     Автоматические бекапы                    │
│                    (каждую ночь в 03:00)                     │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
                  ┌────────────────┐
                  │ BackupManager  │
                  └────────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌──────────────┐  ┌──────────────┐
│   PostgreSQL  │  │    Сжатие    │  │ Яндекс.Диск  │
│    pg_dump    │  │     gzip     │  │   загрузка   │
└───────────────┘  └──────────────┘  └──────────────┘
        │                  │                  │
        └──────────────────┴──────────────────┘
                           ▼
               Локальный бекап + Облачный бекап
```

### Логика ротации бекапов

**На Яндекс.Диске (7 файлов):**
- `lunch_bot_backup_monday.sql.gz` - обновляется каждый понедельник
- `lunch_bot_backup_tuesday.sql.gz` - обновляется каждый вторник
- ...и т.д. для всех дней недели

**Локально:**
- Все бекапы с полными временными метками
- Формат: `lunch_bot_backup_{weekday}_{YYYY-MM-DD_HH-MM-SS}.sql.gz`
- Автоматически удаляются бекапы старше 7 дней

### Что включается в бекап

**Полностью (все данные):**
- `users` - все пользователи и сотрудники
- `menu` - меню на неделю
- `holidays` - праздники
- `bot_settings` - настройки бота
- `bitrix_mapping` - связи с Bitrix24

**За последние N месяцев (по умолчанию 3):**
- `orders` - заказы обедов
- `admin_messages` - сообщения администраторов
- `feedback_messages` - обратная связь

### Безопасность

- Токен Яндекс.Диска хранится в `.env` (не коммитится в Git)
- Бекапы содержат персональные данные (ограничен доступ)
- Использование OAuth токена для Яндекс.Диска
- Автоматическая очистка старых бекапов

### Производительность

- Создание бекапа занимает 1-3 минуты (зависит от размера БД)
- Типичный размер сжатого бекапа: 1-5 МБ
- Загрузка на Яндекс.Диск: 10-30 секунд
- Минимальное влияние на работу бота (выполняется ночью)

### Восстановление

Поддерживается восстановление из:
- Локальных бекапов (`data/backups/`)
- Бекапов с Яндекс.Диска

Подробная инструкция: [BACKUP_SETUP.md](BACKUP_SETUP.md#восстановление-из-бекапа)

### Установка и настройка

**Быстрый старт (5 минут):**
См. [BACKUP_QUICKSTART.md](BACKUP_QUICKSTART.md)

**Подробная инструкция:**
См. [BACKUP_SETUP.md](BACKUP_SETUP.md)

### Зависимости

- Python >= 3.9
- PostgreSQL >= 12
- `yadisk` >= 3.0.0
- `pg_dump` (PostgreSQL client)

### Совместимость

- ✅ Совместимо с текущей версией бота 2.5.0
- ✅ Не требует изменений в существующих таблицах БД
- ✅ Работает в Docker-контейнере
- ✅ Поддерживает hot-reload

### Известные ограничения

1. Требуется токен Яндекс.Диска для загрузки в облако
2. pg_dump должен быть установлен в контейнере (уже есть)
3. Бекапы создаются только в формате SQL (не binary)
4. Максимальный размер бекапа на Яндекс.Диске ограничен квотой

### Планы на будущее

- [ ] Поддержка других облачных хранилищ (Google Drive, Dropbox)
- [ ] Уведомления администраторов о статусе бекапов
- [ ] Веб-интерфейс для управления бекапами
- [ ] Автоматическое тестирование восстановления
- [ ] Инкрементальные бекапы
- [ ] Шифрование бекапов

### Миграция с предыдущей версии

Если у вас была старая система бекапов в `db.py`:

1. Старые бекапы в `data/backups/` сохранятся
2. Новая система создаст свои бекапы в том же месте
3. Формат имени файла изменился (добавился день недели)
4. Старые бекапы можно удалить вручную или оставить

### Тестирование

Протестировано на:
- ✅ PostgreSQL 15
- ✅ Python 3.9
- ✅ Docker 20.10+
- ✅ Яндекс.Диск API v1

### Логирование

Все операции бекапа логируются:
- Успешное создание бекапов
- Ошибки при создании
- Загрузка на Яндекс.Диск
- Очистка старых файлов

Просмотр логов:
```bash
docker logs lunch_bot | grep -i backup
```

### Обратная связь

Если вы обнаружили проблемы или у вас есть предложения по улучшению системы бекапов, создайте issue в репозитории проекта.

---

**Автор:** Claude Sonnet 4.5
**Дата:** 2026-01-15
